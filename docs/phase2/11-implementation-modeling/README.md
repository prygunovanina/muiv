# Моделирование реализации

Для демонстрации взаимодействия компонентов системы при выполнении типовой операции разработана UML-диаграмма последовательности для процесса создания и регистрации нового документа.

## Участники взаимодействия

### Пользователь
Инициатор процесса создания документа

### Веб-интерфейс
Клиентское приложение в браузере

### API Gateway
Шлюз для маршрутизации запросов

### Сервис аутентификации
Проверка прав доступа

### Сервис документов
Управление метаданными документов

### Сервис хранения файлов
Управление файлами документов

### База данных
Хранилище метаданных

### Очередь сообщений
Асинхронная передача событий

### Сервис индексации
Полнотекстовая индексация документов

## Последовательность взаимодействия

### Этап 1. Инициация создания документа
Пользователь инициирует создание документа через веб-интерфейс, заполняя форму с реквизитами документа и прикрепляя файл.

### Этап 2. Отправка запроса
Веб-интерфейс отправляет HTTP POST запрос к API Gateway с данными документа и файлом. В заголовках запроса передается токен аутентификации пользователя.

### Этап 3. Проверка аутентификации
API Gateway направляет запрос в Сервис аутентификации для проверки токена. Сервис аутентификации проверяет валидность токена, извлекает идентификатор пользователя и его роли.

### Этап 4. Обработка результата аутентификации
При успешной аутентификации API Gateway пересылает запрос в Сервис документов. Если аутентификация неуспешна, возвращается ошибка 401 Unauthorized пользователю через веб-интерфейс.

### Этап 5. Валидация данных
Сервис документов получает данные документа и выполняет валидацию реквизитов. Проверяется заполнение обязательных полей, корректность форматов данных, соответствие справочникам.

### Этап 6. Генерация идентификатора
После успешной валидации Сервис документов генерирует уникальный идентификатор документа используя алгоритм Snowflake.

### Этап 7. Сохранение файла
Сервис документов обращается к Сервису хранения файлов с запросом на сохранение прикрепленного файла. Передается файл и сгенерированный идентификатор документа.

### Этап 8. Обработка файла в хранилище
Сервис хранения файлов сохраняет файл в объектное хранилище MinIO, используя идентификатор документа как имя объекта. Выполняется антивирусная проверка файла перед сохранением.

### Этап 9. Получение URL файла
Сервис хранения файлов возвращает URL сохраненного файла в Сервис документов.

### Этап 10. Формирование метаданных
Сервис документов формирует запись метаданных документа, включающую сгенерированный идентификатор, реквизиты из формы, URL файла, идентификатор пользователя-создателя, временную метку создания.

### Этап 11. Сохранение в базу данных
Сервис документов сохраняет запись в Базу данных через выполнение SQL INSERT запроса. База данных возвращает подтверждение успешного сохранения.

### Этап 12. Публикация события
Сервис документов публикует событие "DocumentCreated" в Очередь сообщений Kafka. Событие содержит идентификатор документа и URL файла.

### Этап 13. Возврат ответа пользователю
Сервис документов возвращает ответ с деталями созданного документа в API Gateway. API Gateway пересылает ответ в Веб-интерфейс. Веб-интерфейс отображает пользователю сообщение об успешном создании документа с его регистрационным номером.

### Этап 14. Асинхронная индексация
Параллельно, Сервис индексации, подписанный на событие "DocumentCreated", извлекает сообщение из Очереди.

### Этап 15. Загрузка файла для индексации
Сервис индексации загружает файл документа из Сервиса хранения файлов по URL из события.

### Этап 16. Обработка и индексация
Сервис индексации извлекает текстовое содержимое из файла, обрабатывает текст и индексирует документ в ElasticSearch.

### Этап 17. Завершение индексации
После завершения индексации Сервис индексации публикует событие "DocumentIndexed" в Очередь сообщений.

## Альтернативные сценарии

### Ошибка валидации
Если валидация реквизитов неуспешна, Сервис документов возвращает ошибку 400 Bad Request с описанием проблем валидации. Документ не создается.

### Обнаружение вируса
Если при сохранении файла обнаружен вирус, Сервис хранения файлов возвращает ошибку 406 Not Acceptable. Сервис документов информирует пользователя о проблеме и не создает документ.

### Ошибка сохранения в БД
Если при сохранении в базу данных возникает ошибка (нарушение ограничений целостности), Сервис документов выполняет откат операции, удаляет сохраненный файл из хранилища через вызов Сервиса хранения файлов, возвращает ошибку 500 Internal Server Error пользователю.

## Особенности взаимодействия

Диаграмма последовательности демонстрирует синхронную часть процесса создания документа с немедленным ответом пользователю и асинхронную обработку индексации документа без блокирования пользовательского интерфейса. Разделение ответственности между сервисами и использование очереди сообщений обеспечивает слабую связанность компонентов и устойчивость системы к временным сбоям отдельных сервисов.
