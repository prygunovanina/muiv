# Проектирование алгоритмов

Рассмотрено проектирование алгоритма индексации документа для полнотекстового поиска как одного из критически важных компонентов подсистемы поиска.

## Входные данные алгоритма

- Идентификатор документа
- Путь к файлу документа в хранилище
- Метаданные документа

## Выходные данные

- Индексированный документ в поисковой системе
- Статус индексации

## Этапы алгоритма индексации

### Шаг 1. Получение файла документа
Выполняется запрос к API объектного хранилища с передачей идентификатора документа. Получен поток данных файла для дальнейшей обработки.

### Шаг 2. Определение типа документа
По расширению файла или MIME-типу. На основе типа выбирается соответствующий парсер для извлечения текстового содержимого.

### Шаг 3. Извлечение текстового содержимого

#### Инструменты для разных форматов
- Документы Word: Apache POI
- PDF: Apache PDFBox
- HTML: Jsoup
- Простой текст: стандартные средства чтения файлов

Обрабатываются исключения при поврежденных или защищенных файлах.

### Шаг 4. Очистка извлеченного текста
Применяются регулярные выражения для нормализации текста. Удаляются служебные символы, HTML-теги, лишние пробелы.

### Шаг 5. Разбиение текста на токены
Используется токенизатор с учетом особенностей русского языка, обрабатывающий знаки препинания, дефисы, цифры.

### Шаг 6. Приведение токенов к нормальной форме
Применение морфологического анализа. Используется библиотека для русского языка, приводящая слова к начальной форме (лемматизация). Обеспечивается нахождение документов при поиске по различным формам слова.

### Шаг 7. Удаление стоп-слов
Фильтрация частых слов, не несущих смысловой нагрузки ("и", "в", "на", "с"). Используется предопределенный список стоп-слов для русского языка.

### Шаг 8. Формирование индексируемого документа

#### Компоненты
- Уникальный идентификатор документа
- Обработанное текстовое содержимое
- Метаданные (название, автор, дата создания, тип, подразделение)
- Дополнительные поля для фасетного поиска

### Шаг 9. Отправка в ElasticSearch
Через REST API. Используется bulk API для эффективной индексации множества документов.

### Шаг 10. Обработка ответа
При успешной индексации обновляется статус документа, фиксируется время индексации. При ошибке документ помещается в очередь для повторной попытки.

### Шаг 11. Фиксация результата
В журнале аудита с указанием идентификатора документа, статуса, времени выполнения.

## Оптимизация алгоритма

### Кеширование результатов
Для документов, часто переиндексируемых без изменения содержимого. Проверяется хеш-сумма файла, и если она не изменилась, используется кешированный текст.

### Параллельная обработка
Больших документов с разбиением на страницы или разделы, обрабатываемые независимыми потоками. Результаты объединяются перед отправкой в поисковую систему.

### Пакетная индексация
Множества документов одним запросом к ElasticSearch вместо отдельных запросов. Существенно снижаются накладные расходы на сетевое взаимодействие.

### Асинхронная обработка
Использование очереди задач. Запросы на индексацию не блокируют основной процесс обработки, а помещаются в очередь и обрабатываются worker-процессами.

## Сложность алгоритма

### Временная сложность
O(n), где n - размер документа, так как каждый символ обрабатывается ограниченное количество раз

### Пространственная сложность
O(n) для хранения промежуточных результатов обработки

## Обработка исключительных ситуаций

### Отсутствие файла
Документ помечается как требующий внимания администратора

### Ошибки парсинга
Используется частичная индексация по метаданным

### Недоступность поисковой системы
Задача индексации помещается в очередь для повторной попытки

### Превышение максимального размера
Индексируется только начальная часть с фиксацией предупреждения
